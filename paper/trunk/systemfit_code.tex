%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Source code}\label{sec:code}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

The most important function in the \pkg{systemfit} package
is called \code{systemfit}.
It can be used to estimate systems of linear equations
by several different estimation methods.
Furthermore, this package provides some methods
to test hypotheses
(\code{ftest}, \code{wald\-test},
\code{lrtest}, \code{hausman}),
to extract the estimated coefficients (\code{coef})
and to calculate predicted values (\code{predict}).

The source code of \pkg{systemfit} is publicly available
for download from °CRAN° (The Comprehensive R Archive Network,
\url{http://cran.r-project.org/src/contrib/Descriptions/systemfit.html}).
It corresponds exactly to the procedures and formulas
described in the previous section.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection[Basic function systemfit]{The basic function \code{systemfit}}
The basic functionality of this package is provided by the
function \code{systemfit}.
This function estimates the equation system as described
in sections~\ref{sec:Estimation}.
If parameter restrictions are provided, the formulas in
section~\ref{sec:Restrictions} are applied.
Furthermore, the user can control several details of the estimation.
For instance, the
formula to calculate the residual covariance matrix
(see section~\ref{sec:residcov}),
the degrees of freedom for the $t$ tests
(see section~\ref{sec:degreesOfFreedom}), or
the formula for the 3SLS estimation
(see sections~\ref{sec:Estimation} and~\ref{sec:Restrictions})
can be specified by the user.
If \code{systemfit} is applied to
a (classical) °Seemingly Unrelated Regression° analysis with panel-like data,
it calls the hidden internal function \code{.systemfitPanel},
which reshapes the data, creates the formulas to be estimated,
and --- if requested --- specifies restrictions
to ensure that the parameters of all individuals are equal.

The \code{systemfit} function returns many objects
that users might be interested in.
A complete list is available in the documentation of this function
that is included in the package.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Statistical tests}
This section explains the implementation of the statistical tests described in
sections~\ref{sec:testingRestrictions} and~\ref{sec:hausman}.
The method \code{linear.hypothesis.systemfit}
can be used to test linear restrictions on the estimated parameters
by an $F$ test or a Wald/$\chi^2$ test.
Internally, the $F$ statistic is computed by the hidden function
\code{.ftest.systemfit}
and the Wald/$\chi^2$ statistic is computed by the method
\code{linear.hypothesis.default} of the \pkg{car} package.
The method \code{lrtest.systemfit} is a wrapper funtion
to \code{lrtest.default} of the \pkg{lmtest} package,
which computes the Likelihood-ratio (LR) test statistic.
On the other hand, the function \code{hausman.systemfit}
tests the consistency of the 3SLS estimator.
All functions return the empirical test statistic,
the degree(s) of freedom, and the $p$ value.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Efficiency of the code}
We have followed \cite{bates04} to make the code faster and more stable.
First, if a formula contains an inverse of a matrix
that is post-multiplied by a vector,
we use \code{solve(A,b)} instead of \code{solve(A) \%*\% b}.
Second, we calculate crossproducts
by \code{crossprod(X)} or \code{crossprod(X,y)}
instead of \code{t(X) \%*\% X} or \code{t(X) \%*\% y},
respectively.

The matrix $\Omega^{-1}$ that is used to compute the estimated
coefficients and their covariance matrix is of size
$( G \cdot T ) \times ( G \cdot T )$
(see sections~\ref{sec:Estimation} and~\ref{sec:Restrictions}).
In case of large data sets, this matrix $\Omega^{-1}$ gets really huge
and needs a lot of memory.
Therefore, we use the following transformation and compute $X' \Omega^{-1}$
by dividing the $X$ matrix into submatrices,
doing some calculations with these submatrices,
adding up some of these submatrices, and
finally putting the submatrices together, so that
\begin{equation}
X' \Omega^{-1}
%= X' \left( \Sigma^{-1} \otimes I \right)
= \sum_{i=1} \left[ \begin{array}{c}
   \sigma^{1i} {X^1} \\
   \sigma^{2i} {X^2} \\
   \vdots \\
   \sigma^{Gi} {X^G} \\
\end{array} \right]' ,
\end{equation}
where $\sigma^{ij}$ are the elements of the matrix $\Sigma^{-1}$,
and $X^i$ is a submatrix of $X$ that contains the rows
that belong to the $i$'s equation.

